pipeline {
    agent any

    // ‚≠ê TRIGGER: Aceita webhooks do GitHub ## Teste ##
    triggers {
        githubPush()
    }

    environment {
        // Configura√ß√µes do projeto
        PROJECT_DIR = '/opt/apps/aguide-api-quarkus'
        GIT_REPO = 'https://github.com/cleidson-machado/aguide-api-quarkus.git'
        // GIT_BRANCH ser√° detectada automaticamente do webhook ou do checkout
        MAVEN_OPTS = '-Dmaven.repo.local=/var/jenkins_home/.m2/repository'
    }

    stages {
        stage('Pipeline Info') {
            steps {
                script {
                    // Captura quem iniciou o build de forma nativa
                    def causes = currentBuild.getBuildCauses('hudson.model.Cause$UserIdCause')
                    def userName = causes ? causes[0].userName : 'Trigger Autom√°tico'

                    echo '================================================'
                    echo 'üìä INFORMA√á√ïES DO JENKINS PIPELINE'
                    echo '================================================'
                    echo "üÜî Build ID: ${BUILD_ID}"
                    echo "üî¢ Build Number: ${BUILD_NUMBER}"
                    echo "üìù Job Name: ${JOB_NAME}"
                    echo "üîó Build URL: ${BUILD_URL}"
                    echo "üë§ Iniciado por: ${userName}"
                    echo "üåø Branch Git (webhook): ${env.GIT_BRANCH ?: 'N/A'}"
                    echo "üìÇ Workspace: ${WORKSPACE}"
                    echo "üè† Jenkins Home: ${JENKINS_HOME}"
                    echo "üñ•Ô∏è  Node Name: ${NODE_NAME}"
                    echo "‚è∞ Timestamp: ${new Date()}"
                    echo '================================================'
                }
            }
        }

        stage('Validar Branch') {
            steps {
                script {
                    echo 'üîç Validando branch para ambiente de TESTE...'

                    // Captura a branch do webhook GitHub (formato: refs/heads/branch-name)
                    def gitBranch = env.GIT_BRANCH ?: 'refs/heads/develop'
                    def currentBranch = gitBranch.replaceAll('refs/heads/', '').replaceAll('origin/', '')

                    // Salva a branch detectada na vari√°vel de ambiente
                    env.DETECTED_BRANCH = currentBranch

                    echo "üìå Branch detectada do webhook: ${currentBranch}"

                    // ‚≠ê ACEITA: develop, develop-*, feature/* (para PRs)
                    def isValidBranch = currentBranch.startsWith('develop') ||
                                        currentBranch.startsWith('feature/')

                    if (!isValidBranch) {
                        echo "‚ö†Ô∏è  Branch '${currentBranch}' n√£o √© v√°lida para testes"
                        echo "‚ùå Este job aceita apenas: develop, develop-*, feature/*"
                        echo "üö´ Para branch 'main', use o job de produ√ß√£o"
                        currentBuild.result = 'NOT_BUILT'
                        error("Branch ${currentBranch} n√£o permitida neste job de TESTE")
                    }

                    echo "‚úÖ Branch '${currentBranch}' VALIDADA - Prosseguindo com testes..."
                }
            }
        }

        stage('Checkout') {
            steps {
                echo 'üì• Atualizando c√≥digo do reposit√≥rio...'
                script {
                    // Usa a branch detectada no stage anterior
                    def branchToTest = env.DETECTED_BRANCH ?: 'develop'
                    echo "üîÑ Fazendo checkout da branch: ${branchToTest}"

                    sh """
                        cd /opt/apps/aguide-api-quarkus
                        git fetch origin
                        git checkout ${branchToTest}
                        git reset --hard origin/${branchToTest}
                        git clean -fd
                    """
                }

                // Captura informa√ß√µes do commit
                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: "cd /opt/apps/aguide-api-quarkus && git rev-parse --short HEAD",
                        returnStdout: true
                    ).trim()
                    env.GIT_COMMIT_MSG = sh(
                        script: "cd /opt/apps/aguide-api-quarkus && git log -1 --pretty=%B",
                        returnStdout: true
                    ).trim()
                    env.GIT_AUTHOR = sh(
                        script: "cd /opt/apps/aguide-api-quarkus && git log -1 --pretty=%an",
                        returnStdout: true
                    ).trim()
                }

                echo "üìå Commit: ${env.GIT_COMMIT_SHORT}"
                echo "üí¨ Mensagem: ${env.GIT_COMMIT_MSG}"
                echo "üë®‚Äçüíª Autor: ${env.GIT_AUTHOR}"
                echo "üåø Branch testada: ${env.DETECTED_BRANCH}"
            }
        }

        stage('Build Maven') {
            steps {
                echo '================================================'
                echo 'üî® COMPILA√á√ÉO R√ÅPIDA (sem testes)'
                echo '================================================'
                echo 'üìã Objetivo: Validar que o c√≥digo COMPILA'
                echo '‚è© Testes ser√£o executados no pr√≥ximo stage'
                echo '‚ö° Feedback r√°pido: ~30 segundos'
                echo '================================================'
                sh '''
                    cd /opt/apps/aguide-api-quarkus
                    # -DskipTests: Compila mas N√ÉO executa testes
                    # Por qu√™? Separar compila√ß√£o de testes d√° feedback mais r√°pido
                    # Os testes SER√ÉO executados no stage "SonarQube Analysis"
                    ./mvnw clean package -DskipTests
                '''
                echo '‚úÖ Compila√ß√£o conclu√≠da com sucesso!'
            }
        }

        stage('Validar Configura√ß√µes de Teste') {
            steps {
                echo 'üîç Validando configura√ß√µes de seguran√ßa para testes...'
                script {
                    // Verifica se application.properties de teste existe
                    def testPropsExists = fileExists('/opt/apps/aguide-api-quarkus/src/test/resources/application.properties')
                    if (!testPropsExists) {
                        error('‚ùå Arquivo src/test/resources/application.properties N√ÉO encontrado!')
                    }
                    echo '‚úÖ Arquivo de configura√ß√£o de testes encontrado'

                    // Verifica se AuthenticationFilter est√° desabilitado em testes
                    def authFilterDisabled = sh(
                        script: "grep -q 'quarkus.arc.exclude-types=br.com.aguideptbr.features.auth.AuthenticationFilter' /opt/apps/aguide-api-quarkus/src/test/resources/application.properties",
                        returnStatus: true
                    )
                    if (authFilterDisabled != 0) {
                        echo '‚ö†Ô∏è  AVISO: AuthenticationFilter pode N√ÉO estar desabilitado em testes!'
                    } else {
                        echo '‚úÖ AuthenticationFilter desabilitado para testes'
                    }

                    // Verifica se est√° usando banco de teste (quarkus_test)
                    def usingTestDb = sh(
                        script: "grep -q 'quarkus_test' /opt/apps/aguide-api-quarkus/src/test/resources/application.properties",
                        returnStatus: true
                    )
                    if (usingTestDb != 0) {
                        error('‚ùå Database de teste (quarkus_test) N√ÉO configurado!')
                    }
                    echo '‚úÖ Database de teste (quarkus_test) configurado corretamente'

                    // Verifica se Flyway est√° configurado para limpar banco em testes
                    def flywayClean = sh(
                        script: "grep -q 'quarkus.flyway.clean-at-start=true' /opt/apps/aguide-api-quarkus/src/test/resources/application.properties",
                        returnStatus: true
                    )
                    if (flywayClean != 0) {
                        echo '‚ö†Ô∏è  AVISO: Flyway pode n√£o estar configurado para limpar banco em testes'
                    } else {
                        echo '‚úÖ Flyway configurado para limpar banco antes dos testes'
                    }

                    // Verifica se JWT est√° desabilitado em testes
                    def jwtDisabled = sh(
                        script: "grep -q 'quarkus.smallrye-jwt.enabled=false' /opt/apps/aguide-api-quarkus/src/test/resources/application.properties",
                        returnStatus: true
                    )
                    if (jwtDisabled != 0) {
                        echo '‚ö†Ô∏è  AVISO: JWT pode n√£o estar desabilitado em testes (pode causar erro ao carregar chaves)'
                    } else {
                        echo '‚úÖ JWT desabilitado para testes (evita erro de chave p√∫blica)'
                    }

                    echo '================================================'
                    echo '‚úÖ CONFIGURA√á√ïES DE TESTE VALIDADAS:'
                    echo '   üìÅ application.properties: OK'
                    echo '   üîì AuthenticationFilter: DESABILITADO'
                    echo '   üóÑÔ∏è  Database: quarkus_test'
                    echo '   üßπ Flyway clean-at-start: true'
                    echo '================================================'
                }
            }
        }

        stage('Limpar Banco de Testes') {
            steps {
                echo '================================================'
                echo 'üßπ LIMPANDO BANCO DE TESTES (quarkus_test)'
                echo '================================================'
                echo '‚ö†Ô∏è  Flyway clean-at-start desabilitado (causa timeout)'
                echo '‚úÖ Limpeza manual do schema antes dos testes'
                echo '================================================'
                sh '''
                    cd /opt/apps/aguide-api-quarkus

                    # Termina conex√µes ativas
                    docker exec quarkus_postgres psql -U quarkus -d quarkus_test -c \
                        "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = 'quarkus_test' AND pid <> pg_backend_pid();" \
                        2>/dev/null || echo "‚ÑπÔ∏è  Nenhuma conex√£o ativa"

                    # Drop e recria schema
                    docker exec quarkus_postgres psql -U quarkus -d quarkus_test <<EOF
                        DROP SCHEMA IF EXISTS public CASCADE;
                        CREATE SCHEMA public;
                        GRANT ALL ON SCHEMA public TO quarkus;
                        GRANT ALL ON SCHEMA public TO public;
EOF

                    echo "‚úÖ Banco limpo com sucesso!"
                '''
            }
        }

        stage('SonarQube Analysis') {
            steps {
                echo '================================================'
                echo 'üîç Executando TESTES e an√°lise SonarQube...'
                echo '================================================'
                echo 'üóÑÔ∏è  Database: quarkus_test (PostgreSQL)'
                echo 'üîì Autentica√ß√£o: DESABILITADA para testes'
                echo 'üßπ Banco limpo no stage anterior (Flyway apenas migra)'
                echo 'üìä SonarQube: An√°lise de qualidade de c√≥digo'
                echo '================================================'
                script {
                    // Configura o Maven tool
                    def mvn = tool 'Default Maven'

                    // ‚úÖ CONFIGURA√á√ÉO CR√çTICA: No Jenkins (Docker), usar hostname Docker
                    // O application.properties tem fallback para localhost (testes locais)
                    // Mas Jenkins PRECISA usar quarkus_postgres (hostname do container)
                    withEnv([
                        'QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://quarkus_postgres:5432/quarkus_test',
                        'QUARKUS_DATASOURCE_USERNAME=quarkus',
                        'QUARKUS_DATASOURCE_PASSWORD=quarkus123'
                    ]) {
                        withSonarQubeEnv() {
                            sh """
                                cd /opt/apps/aguide-api-quarkus
                                echo '‚ñ∂Ô∏è  Iniciando execu√ß√£o de testes...'
                                echo 'üîó Database URL: \${QUARKUS_DATASOURCE_JDBC_URL}'
                                ${mvn}/bin/mvn verify sonar:sonar \
                                    -Dsonar.projectKey=aguide-api-quarkus \
                                    -Dsonar.projectName='Aguide API Quarkus' \
                                    -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
                            """
                        }
                    }
                }
                echo '================================================'
                echo '‚úÖ Testes e an√°lise SonarQube conclu√≠dos!'
                echo '================================================'
            }
        }

        stage('Verificar Testes Pulados (JWT)') {
            steps {
                echo '================================================'
                echo 'üß™ Verificando testes pulados relacionados a JWT...'
                echo '================================================'
                script {
                    def skippedJwt = sh(
                        script: '''
                            if ls target/surefire-reports/*.txt >/dev/null 2>&1; then
                              grep -R "JWTServiceTest" -l target/surefire-reports/*.txt 2>/dev/null \
                                | xargs -r grep "Skipped:" \
                                | awk -F 'Skipped: ' '{gsub(/[^0-9].*/, "", $2); sum+=$2} END{print sum+0}'
                            else
                              echo 0
                            fi
                        '''.trim(),
                        returnStdout: true
                    ).trim()

                    if (skippedJwt.isInteger() && skippedJwt.toInteger() > 0) {
                        echo "‚ö†Ô∏è  JWTServiceTest teve ${skippedJwt} teste(s) pulado(s)."
                        echo '‚ÑπÔ∏è  Isso √© esperado quando quarkus.smallrye-jwt.enabled=false no profile de teste.'
                    } else {
                        echo '‚úÖ Nenhum teste de JWT pulado.'
                    }
                }
                echo '================================================'
            }
        }

        stage('Resumo de Testes Pulados') {
            steps {
                echo '================================================'
                echo 'üìä Resumo geral de testes pulados (Surefire)...'
                echo '================================================'
                script {
                    def skippedTotal = sh(
                        script: '''
                            if ls target/surefire-reports/*.txt >/dev/null 2>&1; then
                              grep -R "Tests run:" -l target/surefire-reports/*.txt 2>/dev/null \
                                | xargs -r grep "Tests run:" \
                                | awk -F 'Skipped: ' '{gsub(/[^0-9].*/, "", $2); sum+=$2} END{print sum+0}'
                            else
                              echo 0
                            fi
                        '''.trim(),
                        returnStdout: true
                    ).trim()

                    if (skippedTotal.isInteger() && skippedTotal.toInteger() > 0) {
                        echo "‚ö†Ô∏è  Total de testes pulados: ${skippedTotal}"
                        echo '‚ÑπÔ∏è  Verifique se os pulos s√£o esperados (ex.: JWT desabilitado em testes).'
                    } else {
                        echo '‚úÖ Nenhum teste foi pulado.'
                    }
                }
                echo '================================================'
            }
        }

        stage('Verificar Artefatos') {
            steps {
                echo 'üìã Verificando artefatos gerados...'
                sh '''
                    cd /opt/apps/aguide-api-quarkus
                    ls -lh target/
                    ls -lh target/quarkus-app/ || echo "Pasta quarkus-app n√£o encontrada"
                '''
            }
        }
    }

    post {
        success {
            echo '================================================'
            echo '‚úÖ PIPELINE DE TESTES EXECUTADO COM SUCESSO!'
            echo '================================================'
            echo "üéâ Build e testes conclu√≠dos com sucesso!"
            echo "‚úÖ C√≥digo validado para branch de desenvolvimento"
            echo "üî¢ Build #${BUILD_NUMBER} conclu√≠do"
            echo "‚è±Ô∏è  Dura√ß√£o: ${currentBuild.durationString}"
            echo "üîó Console: ${BUILD_URL}console"
            echo "‚ö†Ô∏è  DEPLOY N√ÉO REALIZADO (use Jenkinsfile.production para deploy)"
            echo '================================================'
        }
        failure {
            echo '================================================'
            echo '‚ùå PIPELINE FALHOU!'
            echo '================================================'
            echo "üî¢ Build #${BUILD_NUMBER} com erro"
            echo "üìã Verificar logs: ${BUILD_URL}console"
            echo "üîç Status: ${currentBuild.result}"
            echo '================================================'
        }
        always {
            script {
                def duration = currentBuild.durationString.replace(' and counting', '')
                echo '================================================'
                echo 'üìä RESUMO DA EXECU√á√ÉO'
                echo '================================================'
                echo "üÜî Build ID: ${BUILD_ID}"
                echo "üî¢ Build Number: ${BUILD_NUMBER}"
                echo "üìù Job: ${JOB_NAME}"
                echo "üéØ Status: ${currentBuild.currentResult}"
                echo "‚è±Ô∏è  Dura√ß√£o: ${duration}"
                echo "üåø Branch Testada: ${env.DETECTED_BRANCH ?: 'N/A'}"
                echo "üìå Commit: ${env.GIT_COMMIT_SHORT ?: 'N/A'}"
                echo "üë®‚Äçüíª Autor: ${env.GIT_AUTHOR ?: 'N/A'}"
                echo "‚è∞ Finalizado: ${new Date()}"
                echo '================================================'
            }
        }
    }
}
