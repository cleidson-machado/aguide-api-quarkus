version: '3.8'

services:
  aguide-api:
    # Constr√≥i a imagem a partir do Dockerfile do projeto
    build:
      context: .
      dockerfile: src/main/docker/Dockerfile.jvm
    container_name: aguide-api
    restart: unless-stopped
    environment:
      # üö® PRODU√á√ÉO VPS - USA quarkus_db (PROTEGIDO)
      # Banco de dados aponta para container postgres (mesma rede Docker)
      DB_PROD_HOST: quarkus_postgres
      DB_PROD_PORT: 5432
      DB_PROD_NAME: quarkus_db
      DB_PROD_USERNAME: quarkus
      DB_PROD_PASSWORD: quarkus123

      # üîí SEGURAN√áA: Chave secreta para valida√ß√£o de propriedade
      OWNERSHIP_VALIDATION_SECRET: b8e75a1106e8e13740ea7082f31ef5d550f8787e2eafad2b9fbb5d23c2771c41

      # üîê SSL KEYSTORE (se necess√°rio em produ√ß√£o)
      KEYSTORE_PASSWORD: quarkus

      # ‚ö†Ô∏è CR√çTICO: SEMPRE usar profile 'prod' no VPS!
      # prod = N√£o limpa banco, usa quarkus_db
      # NUNCA usar 'dev' em produ√ß√£o (causaria perda de dados)
      QUARKUS_PROFILE: prod
    ports:
      - "127.0.0.1:8083:8080"
    # - "8083:8083" # Se quiser expor para toda a rede local, mas bloqueado para impedir acesso externo
    # Volume para chaves JWT (security/)
    # A pasta security/ deve existir no host VPS com jwt-private.pem e jwt-public.pem
    volumes:
      - ./security:/deployments/security:ro
    # Conecta este container √† rede que j√° existe
    networks:
      - proxy-network

# Declara que vamos usar uma rede externa (criada pelo outro docker-compose)
networks:
  proxy-network:
    external: true
